name: "Daily Fraud Database Sync"

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at 00:00 UTC (08:00 Taipei Time)
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  sync_data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch and Download Data
        run: |
          mkdir -p data
          
          # 1. Fetch JSON and extract the resourceDownloadUrl
          # The JSON structure is result -> distribution[0] -> resourceDownloadUrl
          GOV_API_URL="https://data.gov.tw/api/v2/rest/dataset/160055"
          
          echo "Fetching metadata from $GOV_API_URL..."
          DOWNLOAD_URL=$(curl -s "$GOV_API_URL" | jq -r '.result.distribution[0].resourceDownloadUrl')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
            echo "Error: Could not extract resourceDownloadUrl from JSON."
            exit 1
          fi
          
          echo "Found download URL: $DOWNLOAD_URL"
          
          # 2. Download the CSV file
          # -f: Fail silently on HTTP errors
          # -L: Follow redirects
          # -A: User-Agent to avoid blocking
          echo "Downloading CSV..."
          curl -f -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" --retry 3 --retry-delay 5 -o data/daily_data.csv "$DOWNLOAD_URL"

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status -s data/daily_data.csv) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data/daily_data.csv
          git commit -m "data: update fraud list from gov source [skip ci]"
          git push
